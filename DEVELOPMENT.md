# Jolly Roger development tips

Jolly Roger is written in [TypeScript](https://www.typescriptlang.org/) using the
[Meteor web framework](https://www.meteor.com/) version 2. To run Jolly Roger locally, you'll
need to first [install Meteor](https://www.meteor.com/install).

Meteor v2 (and therefore Jolly Roger) requires [Node.js](https://nodejs.org/)
v14 for both development and production. This is an old and deprecated version
of Node, so you will probably want to use a version manager such as 
[nvm](https://github.com/nvm-sh/nvm), [Volta](https://volta.sh/),
[asdf](https://asdf-vm.com/) or (my favorite) [mise](https://mise.jdx.dev/) so
you're not stuck with Node v14 on your whole system.

## Running a local server for development

Obtain the source code:

```bash
git clone https://github.com/deathandmayhem/jolly-roger
cd jolly-roger
```

Install dependencies from `npm`:

```bash
meteor npm install
```

Run Meteor:

```bash
meteor
```

This will start up a server on [http://localhost:3000](http://localhost:3000),
which you can navigate to with your web browser of choice.

## Running a production instance

To run Jolly Roger on a server for lots of people to use, see the
[Deployment and Monitoring] documentation for Meteor. There are many ways
to run the server, but it boils down to taking the tarball generated by
`meteor build`, untarring it on some server, setting environment variables
(see below), and running `node main.js`.

You will also need some dependent services, at the very least a
Mongo DB instance (for `$MONGO_URL`), some way to send email (for `$MAIL_URL`),
a web server that can forward to your server and `$PORT`, and some domain
name pointing to that web server (hopefully with an SSL certificate).

As a "canned configuration" for all of that,
[`cloudformation/jolly-roger.yaml`](cloudformation/jolly-roger.yaml) is
a template for [AWS CloudFormation](https://aws.amazon.com/cloudformation/).
You will need to edit it for your use (change the domain name, etc) but then
it can spin up a full production system including Jolly Roger, MongoDB,
a load balancer, a TURN server, SSL certificates, autoscaling and so on
using Amazon Web Services with a modest footprint.

## Server environment variables

You can configure development and production Jolly Roger servers with a
number of environment variables.

- `$CLUSTER_WORKERS_COUNT` ([cluster](https://github.com/meteorhacks/cluster)) -
  server process count, `"auto"` for the machine's core count, 1 by default.

- `$MAIL_URL` ([email](https://docs.meteor.com/api/email)) - an `smtp://` or
  `smtps://` URL for sending email, mostly for user signup. If your server
  has a self-signed TLS certificate, add `?tls.rejectUnauthorized=false` to the URL.

- `$MONGO_URL` ([Meteor core](https://docs.meteor.com/environment-variables#MONGO_URL)) -
  the [MongoDB server](https://www.mongodb.com/) to use for storing Hunt and user
  data. This can be a server you run, or a server hosted on something like
  [MongoDB Atlas](https://www.mongodb.com/atlas/database). In development, a mini
  local MongoDB instance is set up for you.

- `$MONGO_OPLOG_URL` ([Meteor core](https://docs.meteor.com/environment-variables#MONGO_OPLOG_URL)) -
  the [MongoDB operations log server](https://www.mongodb.com/docs/manual/core/replica-set-oplog/)
  to use for change monitoring. Strongly recommended for production, not
  needed for development. Requires the server to be a
  [replica set](https://www.mongodb.com/docs/manual/replication/) (can be size 1).
  Typically this is the `$MONGO_URL` with `/local` replacing the Jolly Roger database name.

- `$PORT` ([Meteor core](https://docs.meteor.com/environment-variables#PORT)) - the
  socket port to listen for HTTP connections. Defaults to 3000. For dev, use `--port=XXXX` instead.

- `$ROOT_URL` ([Meteor core](https://docs.meteor.com/environment-variables#ROOT_URL)) -
  the base URL used to access your server. Not needed for dev servers.

- `$TURN_SERVER` - the URL of a
  [TURN server](https://webrtc.org/getting-started/turn-server)
  for robust audio chat connectivity.

- `$TURN_SECRET` - the secret needed to authenticate with `$TURN_SERVER`.

Also see the other environment variables defined by
[Meteor core](https://docs.meteor.com/environment-variables) and other packages.

## Setting up a fresh Jolly Roger server

When you start a server with an empty database (development or production),
the server will initialize itself but you have to do some setup steps in the
web interface.

### Admin account creation

Loading the Jolly Roger web interface for the first time will prompt you to
create a user with the `admin` role and log you in as that user. Once that's
done, you can begin using Jolly Roger, invite other users and so on.

### Server options and integrations

Users with the `admin` role can configure other server options from the setup
page (look for "Server setup" in the user pulldown menu in the upper right).
This is where you configure integration with Google, Discord, etc.; the page
walks you through the steps to generate the required keys and such.

### Example hunt data

Jolly Roger ships with a fixture representing data from the 2018 MIT Mystery
Hunt, to get a sense of what a fully-populated UI might look like.

If you haven't yet created any hunts in your Jolly Roger instance, then you can
load the homepage (click the logo in the upper left) and click the
"Create sample hunt" button. Otherwise, you can open the **browser** javascript
console (not the Meteor shell) and run the following:

```js
Meteor.call("Hunts.methods.createFixture");
```

Either way, upon success, you should see a hunt named "Mystery Hunt 2018" in the
list at [http://localhost:3000/hunts/](http://localhost:3000/hunts/).
